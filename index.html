<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizbee - Word Puzzle Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* Auth Screen */
        .google-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .google-btn:hover {
            background: #f8f8f8;
            border-color: #667eea;
        }

        /* Theme Input */
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Game Screen */
        #selectedTheme {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        #wordBoxes {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .letter-box {
            width: 50px;
            height: 50px;
            border: 3px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background: white;
            cursor: move;
        }

        .letter-box.small-font {
            font-size: 20px;
        }

        .letter-box.tiny-font {
            font-size: 16px;
        }

        .letter-box.correct {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }

        .letter-box.present {
            background: #f6ad55;
            color: white;
            border-color: #f6ad55;
        }

        .letter-box.absent {
            background: #cbd5e0;
            border-color: #cbd5e0;
        }

        #guessCount {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        /* Keyboard */
        #keyboard {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
        }

        .keyboard-row {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .key {
            padding: 15px;
            background: #e2e8f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            min-width: 35px;
            transition: all 0.2s;
        }

        .key:hover {
            background: #cbd5e0;
        }

        .key.wide {
            min-width: 65px;
            font-size: 12px;
        }

        .key.correct {
            background: #48bb78;
            color: white;
        }

        .key.present {
            background: #f6ad55;
            color: white;
        }

        .key.used {
            background: #cbd5e0;
            color: #718096;
        }

        /* Messages */
        .message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
        }

        .message.win {
            background: #c6f6d5;
            color: #22543d;
        }

        .message.lose {
            background: #fed7d7;
            color: #742a2a;
        }

        #errorMessage {
            background: #fef5e7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #f39c12;
        }

        /* Options Container */
        #optionsContainer {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-button {
            padding: 15px;
            background: #f7fafc;
            border: 2px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .option-button:hover {
            background: #667eea;
            color: white;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            text-align: center;
        }

        .modal h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .modal p {
            margin-bottom: 20px;
            color: #666;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            color: #718096;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Browse Themes */
        .theme-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .language-section {
            margin-bottom: 25px;
        }

        .language-header {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .difficulty-section {
            margin-bottom: 15px;
            padding-left: 10px;
        }

        .difficulty-header {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .theme-item {
            background: #f7fafc;
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .theme-item:hover {
            background: #edf2f7;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .theme-name {
            font-weight: bold;
            color: #2d3748;
        }

        .theme-stats {
            display: flex;
            gap: 10px;
            font-size: 0.85em;
            color: #718096;
        }

        .theme-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        /* Hint Button */
        #hintButton {
            background: #f6ad55;
            margin-top: 10px;
        }

        #hintButton:hover {
            background: #ed8936;
        }

        #hintText {
            background: #fef5e7;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-style: italic;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêù Wizbee</h1>
        <p class="subtitle">AI Word Puzzle Game</p>

        <div id="errorMessage" class="hidden"></div>

        <!-- Auth Screen -->
        <div id="authScreen" class="screen active">
            <div id="g_id_onload"
                 data-client_id="635584185020-emmqudvevrf1j01lpu6nha4tfneju6t2.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse">
            </div>
            <div id="g_id_signin"></div>
        </div>

        <!-- Theme Input Screen -->
        <div id="themeInputScreen" class="screen">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('newTheme')">New Theme</button>
                <button class="tab" onclick="switchTab('browseThemes')">Browse Themes</button>
            </div>

            <!-- New Theme Tab -->
            <div id="newThemeTab" class="tab-content active">
                <h2>Enter Your Theme</h2>
                <input type="text" id="themeInput" placeholder="e.g., 3 letter animals for 5 year old" />
                <button onclick="generateThemes()">Generate Puzzle</button>
                <div id="optionsContainer"></div>
            </div>

            <!-- Browse Themes Tab -->
            <div id="browseThemesTab" class="tab-content">
                <h2>Popular Themes</h2>
                <div id="themesList" class="theme-list">
                    <div class="loading">Loading themes...</div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <div id="selectedTheme"></div>
            <div id="guessCount"></div>
            <div id="wordBoxes"></div>
            
            <button id="hintButton" onclick="getHint()" class="hidden">Get Hint</button>
            <div id="hintText" class="hidden"></div>
            
            <div id="keyboard"></div>
            
            <div id="gameMessage" class="hidden"></div>
            
            <button onclick="resetToTheme()" style="margin-top: 20px; background: #718096;">
                New Theme
            </button>
        </div>

        <!-- Upgrade Modal -->
        <div id="upgradeModal" class="modal hidden">
            <div class="modal-content">
                <h2>üéâ Upgrade to Premium</h2>
                <p>You've used your 4 free themes!</p>
                <p>Get 128 more themes for just <strong>$0.99</strong></p>
                <button onclick="window.location.href='/premium'">Upgrade Now</button>
                <button onclick="closeUpgradeModal()" style="background: #718096; margin-top: 10px;">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Configuration
        const GOOGLE_CLIENT_ID = '635584185020-emmqudvevrf1j01lpu6nha4tfneju6t2.apps.googleusercontent.com';
        const API_URL = 'https://wizbee-backend-production.up.railway.app';
        
        // State
        let userEmail = localStorage.getItem('userEmail');
        let authToken = localStorage.getItem('authToken');
        let currentWords = [];
        let currentWord = '';
        let currentWordIndex = 0;
        let currentGuess = '';
        let guessCount = 0;
        let maxGuesses = 8;
        let gameOver = false;
        let currentLanguage = 'en';
        let selectedThemeWord = '';
        let hintsUsed = 0;
        let currentThemeId = null;
        let wordStartTime = null;
        let letterSwapCount = 0;
        let errorPatterns = [];

        // Initialize
        window.onload = function() {
            if (authToken && userEmail) {
                showScreen('themeInputScreen');
                loadBrowseThemes();
            } else {
                showScreen('authScreen');
                initializeGoogleSignIn();
            }
        };

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tabName === 'newTheme') {
                document.getElementById('newThemeTab').classList.add('active');
            } else if (tabName === 'browseThemes') {
                document.getElementById('browseThemesTab').classList.add('active');
            }
        }

        async function loadBrowseThemes() {
            const themesList = document.getElementById('themesList');
            
            try {
                const response = await fetch(`${API_URL}/api/browse-themes`);
                const data = await response.json();
                
                if (!response.ok) {
                    themesList.innerHTML = '<div class="loading">Failed to load themes</div>';
                    return;
                }

                const languageNames = {
                    en: 'üá¨üáß English',
                    fr: 'üá´üá∑ French',
                    es: 'üá™üá∏ Spanish',
                    de: 'üá©üá™ German',
                    it: 'üáÆüáπ Italian',
                    pt: 'üáµüáπ Portuguese',
                    nl: 'üá≥üá± Dutch',
                    sv: 'üá∏üá™ Swedish',
                    pl: 'üáµüá± Polish',
                    fi: 'üá´üáÆ Finnish'
                };

                const difficultyNames = {
                    easy: '‚≠ê Easy (Ages 5-7)',
                    medium: '‚≠ê‚≠ê Medium (Ages 8-10)',
                    hard: '‚≠ê‚≠ê‚≠ê Hard (Ages 11+)'
                };

                let html = '';
                
                // Sort languages alphabetically
                const sortedLanguages = Object.keys(data.themes).sort();
                
                sortedLanguages.forEach(lang => {
                    const languageName = languageNames[lang] || lang.toUpperCase();
                    
                    html += `<div class="language-section">`;
                    html += `<div class="language-header">${languageName}</div>`;
                    
                    ['easy', 'medium', 'hard'].forEach(difficulty => {
                        const themes = data.themes[lang][difficulty];
                        
                        if (themes && themes.length > 0) {
                            html += `<div class="difficulty-section">`;
                            html += `<div class="difficulty-header">${difficultyNames[difficulty]}</div>`;
                            
                            themes.forEach(theme => {
                                html += `
                                    <div class="theme-item" onclick="launchThemeFromBrowser('${theme.cacheKey}', '${theme.displayName}')">
                                        <span class="theme-name">${theme.displayName}</span>
                                        <div class="theme-stats">
                                            <span class="theme-badge">${theme.wordCount} words</span>
                                            <span style="color: #cbd5e0;">üë• ${theme.useCount}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += `</div>`;
                        }
                    });
                    
                    html += `</div>`;
                });

                if (html === '') {
                    html = '<div class="loading">No themes available yet. Be the first to create one!</div>';
                }
                
                themesList.innerHTML = html;

            } catch (error) {
                console.error('Error loading themes:', error);
                themesList.innerHTML = '<div class="loading">Failed to load themes</div>';
            }
        }

        async function launchThemeFromBrowser(cacheKey, displayName) {
            // Parse cache key back to theme string
            // Format: category_length_language_difficulty
            const parts = cacheKey.split('_');
            const category = parts[0];
            const length = parts[1];
            const difficulty = parts[3];
            
            // Map difficulty to age
            const ageMap = {
                easy: '5 year old',
                medium: '9 year old',
                hard: '12 year old'
            };
            
            const age = ageMap[difficulty] || '';
            const themeString = `${length} letter ${category} ${age}`.trim();
            
            console.log(`Launching theme: ${themeString} (from cache: ${cacheKey})`);
            
            // Use the same generate flow
            try {
                const response = await fetch(`${API_URL}/api/generate-word`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ theme: themeString })
                });

                const data = await response.json();

                if (response.status === 429 || response.status === 503) {
                    showError(data.message || 'Theme limit reached!');
                    document.getElementById('upgradeModal').classList.remove('hidden');
                    return;
                }

                if (response.status === 400) {
                    showError(data.message);
                    return;
                }

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to generate');
                }

                console.log('Starting game with words:', data.words);
                startGame(data);

            } catch (error) {
                showError(error.message || 'Failed to launch theme');
            }
        }

        function initializeGoogleSignIn() {
            let attempts = 0;
            const maxAttempts = 50;
            
            const checkGoogle = setInterval(() => {
                attempts++;
                if (typeof google !== 'undefined' && google.accounts) {
                    clearInterval(checkGoogle);
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: handleCredentialResponse
                    });
                    google.accounts.id.renderButton(
                        document.getElementById('g_id_signin'),
                        { 
                            theme: 'outline', 
                            size: 'large',
                            width: 300
                        }
                    );
                    // Also prompt if needed
                    google.accounts.id.prompt();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkGoogle);
                    console.error('Google Sign-In failed to load');
                    showError('Failed to load Google Sign-In. Please refresh the page.');
                }
            }, 100);
        }

        async function handleCredentialResponse(response) {
            try {
                const decoded = JSON.parse(atob(response.credential.split('.')[1]));
                userEmail = decoded.email;
                
                const authResponse = await fetch(`${API_URL}/auth/google`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, googleToken: response.credential })
                });
                
                const data = await authResponse.json();
                authToken = data.token;
                
                localStorage.setItem('userEmail', userEmail);
                localStorage.setItem('authToken', authToken);
                
                showScreen('themeInputScreen');
                loadBrowseThemes();
            } catch (error) {
                showError('Authentication failed. Please try again.');
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            const duration = message.length > 80 ? 8000 : 5000;
            setTimeout(() => errorDiv.classList.add('hidden'), duration);
        }

        async function generateThemes() {
            const theme = document.getElementById('themeInput').value.trim();
            
            if (!theme) {
                showError('Please enter a theme!');
                return;
            }

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '<p>Generating...</p>';

            try {
                const response = await fetch(`${API_URL}/api/generate-word`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ theme })
                });

                const data = await response.json();

                if (response.status === 429 || response.status === 503) {
                    optionsContainer.innerHTML = '';
                    showError(data.message || 'Theme limit reached!');
                    document.getElementById('themeInput').disabled = true;
                    document.getElementById('themeInput').style.display = 'none';
                    document.querySelector('#themeInputScreen h2').style.display = 'none';
                    document.querySelector('#themeInputScreen button').style.display = 'none';
                    document.getElementById('upgradeModal').classList.remove('hidden');
                    return;
                }

                if (response.status === 400) {
                    optionsContainer.innerHTML = '';
                    showError(data.message);
                    return;
                }

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to generate');
                }

                optionsContainer.innerHTML = '';
                console.log('Starting game with words:', data.words);
                startGame(data);

            } catch (error) {
                optionsContainer.innerHTML = '';
                showError(error.message || 'Failed to generate puzzle');
            }
        }

        function startGame(data) {
            currentWords = data.words;
            currentThemeId = data.themeId || null;
            currentWordIndex = 0;
            selectedThemeWord = data.theme;
            currentLanguage = data.language || 'en';
            maxGuesses = data.guesses || 8;
            
            letterSwapCount = 0;
            errorPatterns = [];
            wordStartTime = Date.now();
            
            createKeyboard(currentLanguage);
            nextWord();
            showScreen('gameScreen');
        }

        function nextWord() {
            if (currentWordIndex >= currentWords.length) {
                showGameMessage('üéâ Theme Complete! You finished all words!', 'win');
                setTimeout(() => resetToTheme(), 3000);
                return;
            }

            currentWord = currentWords[currentWordIndex].toUpperCase();
            currentGuess = '';
            guessCount = 0;
            gameOver = false;
            hintsUsed = 0;
            wordStartTime = Date.now();
            letterSwapCount = 0;
            errorPatterns = [];

            document.getElementById('selectedTheme').textContent = 
                `${selectedThemeWord} (${currentWordIndex + 1}/${currentWords.length})`;
            document.getElementById('gameMessage').classList.add('hidden');
            document.getElementById('hintButton').classList.remove('hidden');
            document.getElementById('hintText').classList.add('hidden');
            
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('correct', 'present', 'used');
            });
            
            createWordBoxes();
            updateGuessCount();
        }

        function createWordBoxes() {
            const container = document.getElementById('wordBoxes');
            container.innerHTML = '';
            
            let fontSizeClass = '';
            if (currentWord.length > 9) fontSizeClass = 'tiny-font';
            else if (currentWord.length > 6) fontSizeClass = 'small-font';
            
            for (let i = 0; i < currentWord.length; i++) {
                const box = document.createElement('div');
                box.className = `letter-box ${fontSizeClass}`;
                box.id = `box-${i}`;
                box.setAttribute('draggable', 'true');
                box.addEventListener('dragstart', handleDragStart);
                box.addEventListener('dragover', handleDragOver);
                box.addEventListener('drop', handleDrop);
                container.appendChild(box);
            }
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            if (draggedElement !== e.target && e.target.classList.contains('letter-box')) {
                const draggedIndex = Array.from(draggedElement.parentNode.children).indexOf(draggedElement);
                const targetIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
                
                const draggedLetter = currentGuess[draggedIndex];
                const targetLetter = currentGuess[targetIndex];
                
                if (draggedLetter && targetLetter) {
                    let newGuess = currentGuess.split('');
                    newGuess[draggedIndex] = targetLetter;
                    newGuess[targetIndex] = draggedLetter;
                    currentGuess = newGuess.join('');
                    letterSwapCount++;
                    updateCurrentGuessDisplay();
                }
            }
            
            return false;
        }

        function createKeyboard(language) {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';
            
            const layouts = {
                en: [
                    ['Q','W','E','R','T','Y','U','I','O','P'],
                    ['A','S','D','F','G','H','J','K','L'],
                    ['ENTER','Z','X','C','V','B','N','M','‚å´']
                ],
                fr: [
                    ['A','Z','E','R','T','Y','U','I','O','P'],
                    ['Q','S','D','F','G','H','J','K','L','M'],
                    ['ENTER','W','X','C','V','B','N','‚å´']
                ]
            };
            
            const layout = layouts[language] || layouts.en;
            
            layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                
                row.forEach(key => {
                    const keyButton = document.createElement('button');
                    keyButton.className = 'key';
                    keyButton.textContent = key;
                    
                    if (key === 'ENTER' || key === '‚å´') {
                        keyButton.classList.add('wide');
                    }
                    
                    keyButton.onclick = () => handleKeyPress(key);
                    rowDiv.appendChild(keyButton);
                });
                
                keyboard.appendChild(rowDiv);
            });
        }

        function handleKeyPress(key) {
            if (gameOver) return;
            
            if (key === 'ENTER') {
                submitGuess();
            } else if (key === '‚å´') {
                deleteLetter();
            } else {
                addLetter(key);
            }
        }

        function addLetter(letter) {
            if (gameOver) return;
            if (currentGuess.length < currentWord.length) {
                currentGuess += letter;
                updateCurrentGuessDisplay();
            }
        }

        function deleteLetter() {
            if (gameOver) return;
            currentGuess = currentGuess.slice(0, -1);
            updateCurrentGuessDisplay();
        }

        function updateCurrentGuessDisplay() {
            for (let i = 0; i < currentWord.length; i++) {
                const box = document.getElementById(`box-${i}`);
                if (i < currentGuess.length) {
                    box.textContent = currentGuess[i];
                } else {
                    box.textContent = '';
                }
            }
        }

        function detectErrorTypes(guess, targetWord) {
            const errors = [];
            
            const reversalPairs = {
                b: 'd', d: 'b', p: 'q', q: 'p', n: 'u', u: 'n', 
                m: 'w', w: 'm', '6': '9', '9': '6', s: 'z', z: 's'
            };
            
            const visualSimilar = {
                o: '0', '0': 'o', l: '1', '1': 'l', i: 'l', 
                c: 'e', e: 'c', a: 'o', h: 'n', f: 't'
            };
            
            const phoneticSimilar = {
                c: 'k', k: 'c', s: 'c', f: 'ph', ph: 'f',
                j: 'g', g: 'j', i: 'y', y: 'i', w: 'v', v: 'w'
            };
            
            for (let i = 0; i < guess.length; i++) {
                const g = guess[i].toLowerCase();
                const t = targetWord[i].toLowerCase();
                
                if (g !== t) {
                    if (reversalPairs[g] === t) errors.push('reversal');
                    if (visualSimilar[g] === t) errors.push('visual');
                    if (phoneticSimilar[g] === t) errors.push('phonetic');
                    
                    if (i < guess.length - 1 && guess[i] === targetWord[i + 1] && guess[i + 1] === targetWord[i]) {
                        errors.push('sequence');
                    }
                }
            }
            
            const currentErrors = [...new Set(errors)];
            const previousErrors = errorPatterns.length > 0 ? errorPatterns[errorPatterns.length - 1] : [];
            const repeatedErrors = currentErrors.filter(e => previousErrors.includes(e));
            
            if (repeatedErrors.length >= 2) {
                currentErrors.push('repetition');
            }
            
            return [...new Set(currentErrors)];
        }

        async function submitGuess() {
            if (currentGuess.length !== currentWord.length) {
                showError('Complete the word first!');
                return;
            }

            if (gameOver) return;

            guessCount++;
            const errors = detectErrorTypes(currentGuess, currentWord);
            errorPatterns.push(errors);

            if (currentGuess === currentWord) {
                // Win
                for (let i = 0; i < currentWord.length; i++) {
                    document.getElementById(`box-${i}`).classList.add('correct');
                }
                
                updateKeyboardColors();
                gameOver = true;
                
                await recordWordAttempt(true);
                
                showGameMessage('üéâ Correct! Moving to next word...', 'win');
                
                currentWordIndex++;
                setTimeout(() => nextWord(), 2000);
                
            } else if (guessCount >= maxGuesses) {
                // Lose
                gameOver = true;
                await recordWordAttempt(false);
                
                showGameMessage(`‚ùå Game Over! The word was: ${currentWord}`, 'lose');
                setTimeout(() => {
                    currentWordIndex++;
                    nextWord();
                }, 3000);
                
            } else {
                // Continue
                updateBoxColors();
                updateKeyboardColors();
                currentGuess = '';
                updateCurrentGuessDisplay();
                updateGuessCount();
            }
        }

        function updateBoxColors() {
            const letterCounts = {};
            for (let letter of currentWord) {
                letterCounts[letter] = (letterCounts[letter] || 0) + 1;
            }

            for (let i = 0; i < currentGuess.length; i++) {
                const box = document.getElementById(`box-${i}`);
                const guessLetter = currentGuess[i];
                
                if (guessLetter === currentWord[i]) {
                    box.classList.add('correct');
                    letterCounts[guessLetter]--;
                }
            }

            for (let i = 0; i < currentGuess.length; i++) {
                const box = document.getElementById(`box-${i}`);
                const guessLetter = currentGuess[i];
                
                if (!box.classList.contains('correct')) {
                    if (currentWord.includes(guessLetter) && letterCounts[guessLetter] > 0) {
                        box.classList.add('present');
                        letterCounts[guessLetter]--;
                    } else {
                        box.classList.add('absent');
                    }
                }
            }
        }

        function updateKeyboardColors() {
            for (let letter of currentGuess) {
                const keys = document.querySelectorAll('.key');
                keys.forEach(key => {
                    if (key.textContent === letter) {
                        if (currentWord.includes(letter)) {
                            if (currentWord.indexOf(letter) === currentGuess.indexOf(letter)) {
                                key.classList.add('correct');
                            } else {
                                key.classList.add('present');
                            }
                        } else {
                            key.classList.add('used');
                        }
                    }
                });
            }
        }

        function updateGuessCount() {
            document.getElementById('guessCount').textContent = 
                `Guesses: ${guessCount}/${maxGuesses}`;
        }

        function showGameMessage(text, type) {
            const msg = document.getElementById('gameMessage');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.classList.remove('hidden');
        }

        async function getHint() {
            if (hintsUsed > 0) {
                showError('Only one hint per word!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/get-hint`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ word: currentWord, theme: selectedThemeWord })
                });

                const data = await response.json();
                
                document.getElementById('hintText').textContent = `üí° ${data.hint}`;
                document.getElementById('hintText').classList.remove('hidden');
                document.getElementById('hintButton').classList.add('hidden');
                
                hintsUsed++;

            } catch (error) {
                showError('Failed to get hint');
            }
        }

        async function recordWordAttempt(won) {
            if (!currentThemeId) {
                console.log('No theme ID available, skipping record');
                return;
            }

            const timeSeconds = Math.floor((Date.now() - wordStartTime) / 1000);

            try {
                await fetch(`${API_URL}/api/record-word-attempt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        themeId: currentThemeId,
                        word: currentWord,
                        guesses: guessCount,
                        hintsUsed: hintsUsed,
                        won: won,
                        letterSwaps: letterSwapCount,
                        errorTypes: [...new Set(errorPatterns.flat())],
                        timeSeconds: timeSeconds
                    })
                });

                console.log(`‚úÖ Word attempt recorded: ${currentWord} (won: ${won}, errors: ${[...new Set(errorPatterns.flat())].join(', ')})`);

            } catch (error) {
                console.error('Failed to record word attempt:', error);
            }
        }

        function resetToTheme() {
            showScreen('themeInputScreen');
            document.getElementById('themeInput').value = '';
            document.getElementById('optionsContainer').innerHTML = '';
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('gameScreen').classList.contains('active')) {
                if (e.key === 'Enter') {
                    submitGuess();
                } else if (e.key === 'Backspace') {
                    deleteLetter();
                } else if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                    addLetter(e.key.toUpperCase());
                }
            }
        });
    </script>
</body>
</html>
