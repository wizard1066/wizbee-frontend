<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play - Wizbee</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>
            <a href="index.html" style="text-decoration: none; color: inherit;">
                <img src="bee3.gif" alt="Wizbee" style="height: 48px; vertical-align: middle;"> 
                <span style="color: #f59e0b;">Wizbee</span>
            </a>
        </h1>

        <!-- Loading Message -->
        <div id="loadingMessage" style="text-align: center; padding: 60px; color: #718096;">
            <img src="bee2.gif" style="height: 60px;"><br>
            Loading game...
        </div>

        <!-- Game Board -->
        <div id="gameScreen" class="game-screen">
            <div class="theme-display">Theme: <span id="selectedTheme"></span></div>
            
            <!-- CLUE DISPLAY -->
            <div id="clueDisplay" class="clue-display hidden" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 12px;
                margin: 20px 0;
                text-align: center;
                font-size: 18px;
                font-weight: 600;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí° Clue</div>
                <div id="clueText"></div>
            </div>
            
            <div id="wordBoxes" class="word-boxes"></div>
            <div class="guesses-remaining">Guesses remaining: <span id="guessesRemaining"></span></div>
            <div id="keyboard" class="keyboard" hidden></div>

            <input 
            type="text" 
            id="guessInput" 
            autocomplete="off"
            autocorrect="off"
            autocapitalize="characters"
            style="
                position: absolute;
                left: -9999px;
                width: 1px;
                height: 1px;
                opacity: 0;
            "
            />

            <div class="guess-input-container">
                <button id="submitGuess" class="submit-guess" onclick="submitGuess()">Submit Word</button>
                <button id="showClueBtn" class="hint-btn" onclick="showClue()">üí° Show Clue</button>
                <button id="giveUpBtn" class="give-up-btn" onclick="giveUp()">Give Up</button>
            </div>

            <div id="hintDisplay" class="hint-display hidden"></div>
            <div id="previousGuesses" class="previous-guesses"></div>
            <div id="gameMessage" class="message"></div>
            <button id="resetButton" class="play-again hidden" onclick="nextWord()">Next Word ‚Üí</button>
            <button id="backButton" class="play-again hidden" onclick="returnToBrowse()" style="background: #e2e8f0; color: #2d3748;">‚Üê Back to Browse</button>
        </div>

        <!-- Game Summary Modal -->
        <div id="summaryOverlay" class="summary-overlay hidden">
            <div class="summary-modal">
                <h2>üéÆ Game Complete!</h2>
                <div id="summaryContent"></div>
                <button onclick="closeSummary()" class="play-again" style="margin-top: 20px;">
                    Back to Browse
                </button>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden" style="text-align: center; padding: 60px; color: #e53e3e;">
            Failed to load game. <a href="browse.html">Return to browse</a>
        </div>
    </div>

    <script>
        const API_URL = 'https://api.wizbee.app';
        let authToken = null;
        
        // Game state
        let wordList = [];
        let currentWordIndex = 0;
        let currentWord = '';
        let currentGuess = '';
        let remainingGuesses = 0;
        let maxGuesses = 8;
        let guessHistory = [];
        let gameOver = false;
        let selectedThemeWord = '';
        let currentLanguage = 'en';
        let winMessage = 'Correct!';
        let loseMessage = 'Not quite! The word was';
        let wordClues = [];
        let currentClueTimeout = null;
        let hintsUsed = 0;
        let clueViewCount = 0;
        let wordStartTime = null;
        let letterSwapCount = 0;
        let gameResults = [];
        let currentGameData = null;

        let currentThemeId = null;
	    let currentCacheKey = null;

        // Mobile debugging
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            alert('ERROR: ' + msg + '\nLine: ' + lineNo);
            console.error(msg, url, lineNo, columnNo, error);
            return false;
        };

        // Log everything
        console.log = (function(oldLog) {
            return function(...args) {
                alert('LOG: ' + args.join(' '));
                oldLog.apply(console, args);
            };
        })(console.log);

        window.onload = function() {
            authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                window.location.href = 'index.html';
                return;
            }

            const pendingGame = localStorage.getItem('pendingGame');
            if (!pendingGame) {
                showError('No game data found');
                return;
            }

            try {
                const gameData = JSON.parse(pendingGame);
                localStorage.removeItem('pendingGame');
                
                document.getElementById('loadingMessage').style.display = 'none';
                startGame(gameData);
            } catch (error) {
                console.error('Error loading game:', error);
                showError('Failed to load game');
            }
        };

        async function startGame(gameData) {
            console.log('=== START GAME ===');
            
            clueViewCount = 0;  // ‚Üê ADD THIS
            currentGameData = gameData;
            gameResults = [];
            wordList = gameData.words;
            currentWordIndex = 0;
            selectedThemeWord = gameData.theme;
            currentWord = wordList[currentWordIndex];
            maxGuesses = gameData.guesses || 8;
            remainingGuesses = maxGuesses;
            currentLanguage = gameData.language || 'en';
            winMessage = gameData.winMessage || 'Correct!';
            loseMessage = gameData.loseMessage || 'Not quite! The word was';
            wordStartTime = Date.now();
            letterSwapCount = 0;
            wordClues = [];
            console.log('Language:', currentLanguage);
            
            document.getElementById('selectedTheme').textContent = `${selectedThemeWord} (${currentWordIndex + 1}/${wordList.length})`;
            
            createKeyboard(currentLanguage);
            console.log('createKeyboard ok');
            
            // ADD WORD POOL VISUALIZATION
            const gameScreen = document.getElementById('gameScreen');
            const oldViz = document.getElementById('wordPoolContainer');
            if (oldViz) oldViz.remove();

            const visualization = createWordPoolCanvas();
            const themeElement = document.querySelector('.theme-display');
            themeElement.parentNode.insertBefore(visualization, themeElement.nextSibling);

            // Draw visualization
            if (gameData.wordPoolInfo) {
                drawWordPoolVisualization(
                    gameData.wordPoolInfo.totalWords,
                    gameData.wordPoolInfo.selectedIndices
                );
            }
            try {
                await generateAllClues();
            } catch (error) {
                console.error('ERROR generating clues:', error);
                alert('Clue generation failed: ' + error.message);
                wordClues = []; // Continue without clues
            }

            console.log('createWordBoxes');
            createWordBoxes();
            console.log('updateGuessCount');
            updateGuessCount();
            
            if (wordClues.length > 0) {
                showClueAuto(20000);
            }
        }

        function updatePreviousGuesses() {
            const container = document.getElementById('previousGuesses');
            container.innerHTML = ''; // Clear existing
            
            guessHistory.forEach(guess => {
                showGuessFeedback(guess);
            });
        }

        function showGuessFeedback(guess) {
            const container = document.getElementById('previousGuesses');
            const guessDiv = document.createElement('div');
            guessDiv.className = 'previous-guess';

            const wordCopy = currentWord.split('');
            const guessCopy = guess.split('');
            const feedback = new Array(guess.length).fill('absent');

            for (let i = 0; i < guess.length; i++) {
                if (guess[i] === currentWord[i]) {
                    feedback[i] = 'correct';
                    wordCopy[i] = null;
                    guessCopy[i] = null;
                }
            }

            for (let i = 0; i < guess.length; i++) {
                if (guessCopy[i] !== null) {
                    const index = wordCopy.indexOf(guessCopy[i]);
                    if (index !== -1) {
                        feedback[i] = 'present';
                        wordCopy[index] = null;
                    }
                }
            }

            let fontSizeClass = '';
            if (currentWord.length > 9) fontSizeClass = 'tiny-font';
            else if (currentWord.length > 6) fontSizeClass = 'small-font';

            for (let i = 0; i < guess.length; i++) {
            const box = document.createElement('div');
            box.className = `letter-box ${feedback[i]} ${fontSizeClass}`;
            box.textContent = guess[i];
            guessDiv.appendChild(box);
            }

            container.appendChild(guessDiv);
    }
/*
        function updatePreviousGuesses() {
            const container = document.getElementById('previousGuesses');
            
            if (guessHistory.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<h3>Previous Guesses:</h3>';
            
            guessHistory.forEach(guess => {
                html += '<div class="guess-row">';
                
                const feedback = getFeedbackForGuess(guess);
                
                for (let i = 0; i < guess.length; i++) {
                    const colorClass = feedback[i];
                    html += `<div class="guess-letter ${colorClass}">${guess[i]}</div>`;
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        */
        function getFeedbackForGuess(guess) {
            const feedback = [];
            const wordArray = currentWord.split('');
            const guessArray = guess.split('');
            const usedIndices = new Set();

            // Mark correct positions
            for (let i = 0; i < guessArray.length; i++) {
                if (guessArray[i] === wordArray[i]) {
                    feedback[i] = 'correct';
                    usedIndices.add(i);
                }
            }

            // Mark present letters
            for (let i = 0; i < guessArray.length; i++) {
                if (feedback[i] !== 'correct') {
                    let found = false;
                    for (let j = 0; j < wordArray.length; j++) {
                        if (!usedIndices.has(j) && guessArray[i] === wordArray[j]) {
                            feedback[i] = 'present';
                            usedIndices.add(j);
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        feedback[i] = 'incorrect';
                    }
                }
            }

            return feedback;
        }

        function createWordPoolCanvas() {
            const container = document.createElement('div');
            container.id = 'wordPoolContainer';
            container.style.cssText = 'margin: 20px 0; text-align: center;';
            
            const canvas = document.createElement('canvas');
            canvas.id = 'wordPoolCanvas';
            canvas.width = 800;
            canvas.height = 60;
            canvas.style.cssText = 'max-width: 100%; height: auto; border-radius: 8px;';
            
            container.appendChild(canvas);
            return container;
        }

        function drawWordPoolVisualization(totalWords, selectedIndices) {
            const canvas = document.getElementById('wordPoolCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw gradient background (easy -> hard)
            const gradient = ctx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0, '#48bb78');
            gradient.addColorStop(0.5, '#ed8936');
            gradient.addColorStop(1, '#f56565');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 20, width, 20);
            
            // Draw labels
            ctx.fillStyle = '#718096';
            ctx.font = '12px Arial';
            ctx.fillText('Easy', 10, 15);
            ctx.fillText('Hard', width - 35, 15);
            
            // Draw selected word markers
            if (selectedIndices && selectedIndices.length > 0) {
                selectedIndices.forEach(index => {
                    const x = (index / totalWords) * width;
                    
                    ctx.fillStyle = '#2d3748';
                    ctx.beginPath();
                    ctx.arc(x, 30, 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });
            }
        }

        function createKeyboard(language = 'en') {
            const keyboard = document.getElementById('keyboard');
            console.log('[KEYBOARD] Creating keyboard for language:', language);
            const layouts = {
                'en': [
                    ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
                    ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'],
                    ['ENTER', 'Z', 'X', 'C', 'V', 'B', 'N', 'M', '‚å´']
                ],
                fr: [
                ['A','Z','E','R','T','Y','U','I','O','P'],
                ['Q','S','D','F','G','H','J','K','L','M'],
                ['W','X','C','V','B','N','√â','√à','√ä','√Ä','‚å´']
            ],
            es: [
                ['Q','W','E','R','T','Y','U','I','O','P'],
                ['A','S','D','F','G','H','J','K','L','√ë'],
                ['Z','X','C','V','B','N','M','√Å','√â','√ç','√ì','√ö','‚å´']
            ],
            de: [
                ['Q','W','E','R','T','Z','U','I','O','P','√ú'],
                ['A','S','D','F','G','H','J','K','L','√ñ','√Ñ'],
                ['Y','X','C','V','B','N','M','√ü','‚å´']
            ],
            pl: [
                ['Q','W','E','R','T','Y','U','I','O','P'],
                ['A','S','D','F','G','H','J','K','L','≈Å'],
                ['Z','X','C','V','B','N','M','ƒÑ','ƒÜ','ƒò','≈É','√ì','≈ö','≈π','≈ª','‚å´']
            ],
            it: [
                ['Q','W','E','R','T','Y','U','I','O','P'],
                ['A','S','D','F','G','H','J','K','L'],
                ['Z','X','C','V','B','N','M','√Ä','√à','√â','√å','√í','√ô','‚å´']
            ],
            pt: [
                ['Q','W','E','R','T','Y','U','I','O','P'],
                ['A','S','D','F','G','H','J','K','L','√á'],
                ['Z','X','C','V','B','N','M','√Å','√Ä','√Ç','√É','√â','√â','√ç','√ì','√î','√ï','√ö','‚å´']
            ],
            nl: [
                ['Q','W','E','R','T','Y','U','I','O','P'],
                ['A','S','D','F','G','H','J','K','L'],
                ['Z','X','C','V','B','N','M','‚å´']
            ],
            sv: [
                ['Q','W','E','R','T','Y','U','I','O','P','√Ö'],
                ['A','S','D','F','G','H','J','K','L','√ñ','√Ñ'],
                ['Z','X','C','V','B','N','M','‚å´']
            ],
            fi: [
                ['Q','W','E','R','T','Y','U','I','O','P','√Ö'],
                ['A','S','D','F','G','H','J','K','L','√ñ','√Ñ'],
                ['Z','X','C','V','B','N','M','‚å´']
            ]

            };

            const layout = layouts[language] || layouts['en'];
            let html = '';

            layout.forEach(row => {
                html += '<div class="keyboard-row">';
                row.forEach(key => {
                    html += `<button class="key" onclick="handleKeyPress('${key === '‚å´' ? 'BACKSPACE' : key}')">${key}</button>`;
                });
                html += '</div>';
            });

            keyboard.innerHTML = html;
        }

        function handleKeyPress(key) {
            if (gameOver) return;

            if (key === 'ENTER') {
                submitGuess();
                return;
            }

            if (key === 'BACKSPACE') {
                if (currentGuess.length > 0) {
                    currentGuess = currentGuess.slice(0, -1);
                    updateWordBoxes();
                }
                return;
            }

            if (currentGuess.length < currentWord.length) {
                currentGuess += key;
                updateWordBoxes();
            }
        }

        function createWordBoxes() {
            const container = document.getElementById('wordBoxes');
            let html = '';

            for (let i = 0; i < currentWord.length; i++) {
                html += `<div class="letter-box" id="box-${i}"></div>`;
            }

            container.innerHTML = html;
                // Make boxes clickable to focus input (shows keyboard on mobile)
            container.addEventListener('click', () => {
            const guessInput = document.getElementById('guessInput');
            if (guessInput) {
                guessInput.focus();
            }
    });
        }

        function updateWordBoxes() {
            for (let i = 0; i < currentWord.length; i++) {
                const box = document.getElementById(`box-${i}`);
                if (box) {
                    box.textContent = i < currentGuess.length ? currentGuess[i] : '';
                }
            }
        }

        function submitGuess() {
            if (currentGuess.length !== currentWord.length) return;
            if (gameOver) return;

            const guess = currentGuess.toUpperCase();
            guessHistory.push(guess);

            updatePreviousGuesses();
            
            const feedback = [];
            const wordArray = currentWord.split('');
            const guessArray = guess.split('');
            const usedIndices = new Set();

            for (let i = 0; i < guessArray.length; i++) {
                if (guessArray[i] === wordArray[i]) {
                    feedback[i] = 'correct';
                    usedIndices.add(i);
                }
            }

            for (let i = 0; i < guessArray.length; i++) {
                if (feedback[i] !== 'correct') {
                    let found = false;
                    for (let j = 0; j < wordArray.length; j++) {
                        if (!usedIndices.has(j) && guessArray[i] === wordArray[j]) {
                            feedback[i] = 'present';
                            usedIndices.add(j);
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        feedback[i] = 'incorrect';
                    }
                }
            }

            updateKeyboard(guess, feedback);

            remainingGuesses--;
            updateGuessCount();

            if (guess === currentWord) {
                endGame(true);
            } else if (remainingGuesses === 0) {
                endGame(false);
            }

            currentGuess = '';
            updateWordBoxes();
        }

        function updateKeyboard(guess, feedback) {
            for (let i = 0; i < guess.length; i++) {
                const letter = guess[i];
                const keys = document.querySelectorAll('.key');

                keys.forEach(key => {
                    if (key.textContent === letter) {
                        if (feedback[i] === 'correct' && !key.classList.contains('correct')) {
                            key.classList.remove('present', 'used');
                            key.classList.add('correct');
                        } else if (feedback[i] === 'present' && !key.classList.contains('correct')) {
                            key.classList.remove('used');
                            key.classList.add('present');
                        } else if (feedback[i] === 'incorrect' && !key.classList.contains('correct') && !key.classList.contains('present')) {
                            key.classList.add('used');
                        }
                    }
                });
            }
        }

        function updatePreviousGuesses() {
            const container = document.getElementById('previousGuesses');
            container.innerHTML = ''; // Clear existing
            
            guessHistory.forEach(guess => {
                showGuessFeedback(guess);
            });
        }

        function showGuessFeedback(guess) {
            const container = document.getElementById('previousGuesses');
            const guessDiv = document.createElement('div');
            guessDiv.className = 'previous-guess';
            
            const wordCopy = currentWord.split('');
            const guessCopy = guess.split('');
            const feedback = new Array(guess.length).fill('absent');
            
            for (let i = 0; i < guess.length; i++) {
                if (guess[i] === currentWord[i]) {
                    feedback[i] = 'correct';
                    wordCopy[i] = null;
                    guessCopy[i] = null;
                }
            }
            
            for (let i = 0; i < guess.length; i++) {
                if (guessCopy[i] !== null) {
                    const index = wordCopy.indexOf(guessCopy[i]);
                    if (index !== -1) {
                        feedback[i] = 'present';
                        wordCopy[index] = null;
                    }
                }
            }
            
            let fontSizeClass = '';
            if (currentWord.length > 9) fontSizeClass = 'tiny-font';
            else if (currentWord.length > 6) fontSizeClass = 'small-font';
            
            for (let i = 0; i < guess.length; i++) {
                const box = document.createElement('div');
                box.className = `letter-box ${feedback[i]} ${fontSizeClass}`;
                box.textContent = guess[i];
                guessDiv.appendChild(box);
            }
            
            container.appendChild(guessDiv);
        }

        function updateGuessCount() {
            document.getElementById('guessesRemaining').textContent = remainingGuesses;
        }

        async function recordWordAttempt(won) {
            if (!currentThemeId) return;
            
            try {
                await fetch(`${API_URL}/api/record-word-attempt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        themeId: currentThemeId,
                        word: currentWord,
                        guesses: maxGuesses - remainingGuesses,
                        hintsUsed: hintsUsed,
                        won: won,
                        letterSwaps: letterSwapCount,
                        guessHistory: guessHistory,
                        timeSeconds: Math.floor((Date.now() - wordStartTime) / 1000)
                    })
                });
            } catch (error) {
                console.error('Failed to record:', error);
            }
        }

        function celebrateWin() {
            for (let i = 0; i < currentWord.length; i++) {
                const box = document.getElementById(`box-${i}`);
                setTimeout(() => box.classList.add('flash'), i * 150);
                setTimeout(() => box.classList.remove('flash'), i * 150 + 1000);
                setTimeout(() => box.classList.add('flash'), i * 150 + 1200);
                setTimeout(() => box.classList.remove('flash'), i * 150 + 2200);
            }
        }

        function showGameSummary() {
            console.log('=== SHOW GAME SUMMARY ===');
            console.log('gameResults:', gameResults);

            console.trace('Call stack:'); // Shows WHO called this function
    
            console.log('gameResults:', gameResults);
             console.log('gameResults.length:', gameResults.length);
            const totalWords = gameResults.length;
            const wordsWon = gameResults.filter(r => r.won).length;
            const totalTime = gameResults.reduce((sum, r) => sum + r.timeSeconds, 0);
            const totalGuesses = gameResults.reduce((sum, r) => sum + r.guesses, 0);
            const totalClues = gameResults.reduce((sum, r) => sum + r.cluesViewed, 0);
            
            const avgTime = Math.round(totalTime / totalWords);
            const avgGuesses = (totalGuesses / totalWords).toFixed(1);
            
            let html = `
                <div class="summary-stats">
                    <h3>üìä Overall Stats</h3>
                    <p><strong>Words Won:</strong> ${wordsWon}/${totalWords}</p>
                    <p><strong>Success Rate:</strong> ${Math.round((wordsWon/totalWords)*100)}%</p>
                    <p><strong>Average Time:</strong> ${avgTime}s per word</p>
                    <p><strong>Average Guesses:</strong> ${avgGuesses}</p>
                    <p><strong>Total Clues Used:</strong> ${totalClues}</p>
                </div>
                
                <div class="summary-results">
                    <h3>üìù Word by Word</h3>
            `;
            
            gameResults.forEach((result, index) => {
                const icon = result.won ? '‚úÖ' : '‚ùå';
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                        ${icon} <strong>${result.word}</strong> - 
                        ${result.guesses} guesses, 
                        ${result.timeSeconds}s, 
                        ${result.cluesViewed} clues
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('summaryContent').innerHTML = html;
            document.getElementById('summaryOverlay').classList.remove('hidden');
        }

        function closeSummary() {
            document.getElementById('summaryOverlay').classList.add('hidden');
            window.location.href = 'browse.html';
        }

        async function endGame(won) {
            gameOver = true;
            hideClue();

            await recordWordAttempt(won);

             // Track result for summary
            gameResults.push({
                word: currentWord,
                won: won,
                guesses: maxGuesses - remainingGuesses,
                timeSeconds: Math.floor((Date.now() - wordStartTime) / 1000),
                cluesViewed: clueViewCount
            });

            const messageDiv = document.getElementById('gameMessage');

            if (won) {
                celebrateWin();
                messageDiv.textContent = `üéâ ${winMessage} ${currentWord}`;
                messageDiv.className = 'message win';
            } else {
                messageDiv.textContent = `${loseMessage} ${currentWord}`;
                messageDiv.className = 'message lose';
            }

            document.getElementById('submitGuess').classList.add('hidden');
            document.getElementById('showClueBtn').classList.add('hidden');
            document.getElementById('giveUpBtn').classList.add('hidden');

            // Hide both buttons initially
            document.getElementById('resetButton').classList.add('hidden');
            document.getElementById('backButton').classList.add('hidden');

           // Always show Next Word button (it will trigger summary on last word)
            document.getElementById('resetButton').classList.remove('hidden');
            document.getElementById('backButton').classList.add('hidden');

            // Change button text if it's the last word
            if (currentWordIndex >= wordList.length - 1) {
                document.getElementById('resetButton').textContent = 'üéâ View Summary';
            } else {
                document.getElementById('resetButton').textContent = 'Next Word ‚Üí';
            }

            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function nextWord() {
            console.log('=== NEXT WORD CALLED ===');
            console.log('currentWordIndex:', currentWordIndex);
            console.log('wordList.length:', wordList.length);

            // Check if game is complete
            if (currentWordIndex >= wordList.length - 1) {
                showGameSummary();
                return;
            }

            // Move to next word
            currentWordIndex++;
            currentWord = wordList[currentWordIndex];
            currentGuess = '';
            guessHistory = [];
            remainingGuesses = maxGuesses;
            gameOver = false;
            wordStartTime = Date.now();
            clueViewCount = 0;

            document.getElementById('selectedTheme').textContent = `${selectedThemeWord} (${currentWordIndex + 1}/${wordList.length})`;
            document.getElementById('gameMessage').textContent = '';
            document.getElementById('previousGuesses').innerHTML = '';
            document.getElementById('resetButton').classList.add('hidden');
            document.getElementById('backButton').classList.add('hidden');
            document.getElementById('submitGuess').classList.remove('hidden');
            document.getElementById('showClueBtn').classList.remove('hidden');
            document.getElementById('giveUpBtn').classList.remove('hidden');

            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('correct', 'present', 'used');
            });

            createWordBoxes();
            updateGuessCount();

            // Wire up hidden input for mobile keyboard
            const guessInput = document.getElementById('guessInput');
            if (guessInput) {
                guessInput.value = '';
                guessInput.maxLength = currentWord.length;
                guessInput.focus();
            }

            if (wordClues.length > currentWordIndex) {
                showClueAuto(20000);
            }
        }

        function nextWordDepreciated() {
            if (currentWordIndex >= wordList.length - 1) {
                // Game complete - show summary
                showGameSummary();
                return;
            }

            currentWordIndex++;
            currentWord = wordList[currentWordIndex];
            currentGuess = '';
            guessHistory = [];
            remainingGuesses = maxGuesses;
            gameOver = false;
            wordStartTime = Date.now();
            clueViewCount = 0;  // ‚Üê ADD THIS

            document.getElementById('selectedTheme').textContent = `${selectedThemeWord} (${currentWordIndex + 1}/${wordList.length})`;
            document.getElementById('gameMessage').textContent = '';
            document.getElementById('previousGuesses').innerHTML = '';
            document.getElementById('resetButton').classList.add('hidden');
            document.getElementById('backButton').classList.add('hidden');
            document.getElementById('submitGuess').classList.remove('hidden');
            document.getElementById('showClueBtn').classList.remove('hidden');
            document.getElementById('giveUpBtn').classList.remove('hidden');

            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('correct', 'present', 'used');
            });

            createWordBoxes();
            updateGuessCount();

            if (wordClues.length > currentWordIndex) {
                showClueAuto(20000);
                // Wire up hidden input for mobile keyboard
                const guessInput = document.getElementById('guessInput');
                if (guessInput) {
                    guessInput.value = '';
                    guessInput.maxLength = currentWord.length;
                    
                    guessInput.addEventListener('input', (e) => {
                        currentGuess = e.target.value.toUpperCase();
                        e.target.value = currentGuess;
                        updateWordBoxes();
                    });
                    
                    guessInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            submitGuess();
                        }
                    });
}
            }
        }

        function giveUp() {
            //if (confirm('Give up on this word?')) {
                endGame(false);
            //}
        }

        function returnToBrowse() {
            window.location.href = 'browse.html';
        }

        async function generateAllClues() {
            // Disable and show "thinking" on clue button
            const clueBtn = document.getElementById('showClueBtn');
            const originalText = clueBtn.textContent;
            clueBtn.disabled = true;
            clueBtn.textContent = 'üí≠ Thinking...';
            clueBtn.style.background = '#cbd5e0';
            clueBtn.style.cursor = 'not-allowed';
            
            try {
                const response = await fetch(`${API_URL}/api/generate-clues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        words: wordList,
                        theme: selectedThemeWord,
                        language: currentLanguage,
                        difficulty: currentGameData.difficulty || 'medium' 
                    })
                });

                const data = await response.json();
                
                if (data.clues) {
                    wordClues = data.clues;
                    if (data.winMessage) winMessage = data.winMessage;
                    if (data.loseMessage) loseMessage = data.loseMessage;
                }
            } catch (error) {
                console.error('Error generating clues:', error);
            } finally {
                // Re-enable button
                clueBtn.disabled = false;
                clueBtn.textContent = originalText;
                clueBtn.style.background = '';
                clueBtn.style.cursor = '';
            }
        }

        async function generateAllCluesDepareciated() {
            try {
                const response = await fetch(`${API_URL}/api/generate-clues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        words: wordList,
                        theme: selectedThemeWord,
                        language: currentLanguage
                    })
                });

                const data = await response.json();
                
                if (data.clues) {
                    wordClues = data.clues;
                    if (data.winMessage) winMessage = data.winMessage;
                    if (data.loseMessage) loseMessage = data.loseMessage;
                }
            } catch (error) {
                console.error('Error generating clues:', error);
            }
        }

        function showClue() {
            if (wordClues.length > currentWordIndex) {
                document.getElementById('clueText').textContent = wordClues[currentWordIndex];
                document.getElementById('clueDisplay').classList.remove('hidden');
                clueViewCount++;
            }
        }

        function showClueAuto(duration) {
            if (currentClueTimeout) {
                clearTimeout(currentClueTimeout);
            }

            showClue();

            currentClueTimeout = setTimeout(() => {
                hideClue();
            }, duration);
        }

        function hideClue() {
            document.getElementById('clueDisplay').classList.add('hidden');
            if (currentClueTimeout) {
                clearTimeout(currentClueTimeout);
                currentClueTimeout = null;
            }
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('errorMessage').innerHTML = `${message}. <a href="browse.html">Return to browse</a>`;
        }

        // Keyboard support
        document.addEventListener('keydown', function(e) {
            if (gameOver) return;
            
            if (e.key === 'Enter') {
                submitGuess();
            } else if (e.key === 'Backspace') {
                handleKeyPress('BACKSPACE');
            } else if (/^[a-zA-Z]$/.test(e.key)) {
                handleKeyPress(e.key.toUpperCase());
            }
        });
    </script>
</body>
</html>